var app=angular.module("myApp",["ionic"]);app.factory("$debounce",["$rootScope","$browser","$q","$exceptionHandler",function(b,a,e,f){var h={},d={},g=0;function c(p,m,n){var r=e.defer(),s=r.promise,k=(angular.isDefined(n)&&!n),q,i,o,j=false;angular.forEach(d,function(u,t){if(angular.equals(d[t].fn,p)){j=true;o=t}});if(!j){o=g++;d[o]={fn:p}}else{h[d[o].timeoutId].reject("bounced");a.defer.cancel(d[o].timeoutId)}var l=function(){delete d[o];try{r.resolve(p())}catch(t){r.reject(t);f(t)}if(!k){b.$apply()}};q=a.defer(l,m);d[o].timeoutId=q;i=function(t){delete h[s.$$timeoutId]};s.$$timeoutId=q;h[q]=r;s.then(i,i);return s}c.cancel=function(i){if(i&&i.$$timeoutId in h){h[i.$$timeoutId].reject("canceled");return a.defer.cancel(i.$$timeoutId)}return false};return c}]);app.service("$customHttp",["$http","$ionicLoading",function(b,a){this.get=function(c,d){a.show({template:"loading..."});b.get(c).success(function(e){a.hide();d(e)})}}]);app.config(function(b,a){b.state("start",{url:"/kflStart",templateUrl:"tpl/start.html"}).state("main",{url:"/kflMain",templateUrl:"tpl/main.html",controller:"mainCtrl"}).state("detail",{url:"/kflDetail/:id",templateUrl:"tpl/detail.html",controller:"detailCtrl"}).state("order",{url:"/kflOrder/:cartDetail",templateUrl:"tpl/order.html",controller:"orderCtrl"}).state("myOrder",{url:"/kflMyorder",templateUrl:"tpl/myOrder.html",controller:"myOrderCtrl"}).state("setting",{url:"/kflSetting",templateUrl:"tpl/settings.html",controller:"settingCtrl"}).state("cart",{url:"/kflCart",templateUrl:"tpl/cart.html",controller:"cartCtrl"});a.otherwise("/kflStart")});app.controller("parentCtrl",["$scope","$state",function(a,b){a.data={totalNumInCart:0};a.jump=function(d,c){b.go(d,c)}}]);app.controller("mainCtrl",["$scope","$customHttp","$debounce",function(a,b,c){a.hasMore=true;a.inputTxt={kw:""};b.get("data/2_dish_getbypage.php",function(d){console.log(d);a.dishList=d});a.loadMore=function(){b.get("data/2_dish_getbypage.php?start="+a.dishList.length,function(d){if(d.length<5){a.hasMore=false}a.dishList=a.dishList.concat(d);a.$broadcast("scroll.infiniteScrollComplete")})};a.$watch("inputTxt.kw",function(){c(handleSearch,300)});handleSearch=function(){if(a.inputTxt.kw){b.get("data/3_dish_getbykw.php?kw="+a.inputTxt.kw,function(d){a.dishList=d})}}}]);app.controller("detailCtrl",["$scope","$stateParams","$customHttp","$ionicPopup",function(a,c,b,d){b.get("data/4_dish_getbyid.php?id="+c.id,function(e){a.dish=e[0]});a.addToCart=function(){b.get("data/cart_update.php?uid=1&did="+a.dish.did+"&count=-1",function(e){console.log(e);if(e.msg=="succ"){a.data.totalNumInCart++;d.alert({template:"添加到购物车成功！"})}})}}]);app.controller("orderCtrl",["$scope","$stateParams","$httpParamSerializerJQLike","$customHttp",function(b,d,e,c){console.log(d.cartDetail);var a=0;angular.forEach(angular.fromJson(d.cartDetail),function(g,f){a+=(g.price*g.dishCount)});b.order={userid:1,cartDetail:d.cartDetail,totalprice:a};b.submitOrder=function(){var f=e(b.order);c.get("data/order_add.php?"+f,function(g){console.log(g);if(g[0].msg="succ"){b.result="下单成功，订单编号为"+g[0].oid;b.data.totalNumInCart=0}else{b.result="下单失败！"}})}}]);app.controller("myOrderCtrl",["$scope","$customHttp",function(b,c){var a=sessionStorage.getItem("phone");c.get("data/order_getbyuserid.php?userid=1",function(d){console.log(d);b.orderList=d.data})}]);app.controller("settingCtrl",["$scope","$ionicModal",function(b,a){a.fromTemplateUrl("tpl/about.html",{scope:b}).then(function(c){b.modal=c});b.open=function(){b.modal.show()};b.close=function(){b.modal.hide()}}]);app.controller("cartCtrl",["$scope","$customHttp",function(a,b){a.editEnable=false;a.editShowMsg="编辑";a.funEdit=function(){a.editEnable=!a.editEnable;if(a.editEnable){a.editShowMsg="完成"}else{a.editShowMsg="编辑"}};a.deleteEnable=false;a.deleteShowMsg="删除";a.funDelete=function(){a.deleteEnable=!a.deleteEnable;if(a.deleteEnable){a.deleteShowMsg="完成"}else{a.deleteShowMsg="删除"}};a.deleteItem=function(c){b.get("data/cart_update.php?uid=1&did="+a.dishList[c].did+"&count=-2",function(d){console.log(d);a.dishList.splice(c,1);updateTotaoNum()})};updateTotaoNum=function(){a.data.totalNumInCart=0;angular.forEach(a.dishList,function(d,c){a.data.totalNumInCart+=parseInt(d.dishCount)})};b.get("data/cart_select.php?uid=1",function(c){console.log(c);a.dishList=c.data;updateTotaoNum()});a.sumAll=function(){var c=0;angular.forEach(a.dishList,function(e,d){c+=(e.price*e.dishCount)});return c};a.add=function(c){a.dishList[c].dishCount++;b.get("data/cart_update.php?uid=1&did="+a.dishList[c].did+"&count="+a.dishList[c].dishCount,function(d){console.log(d);updateTotaoNum()})};a.minus=function(c){a.dishList[c].dishCount--;if(a.dishList[c].dishCount==0){a.dishList[c].dishCount=1}else{b.get("data/cart_update.php?uid=1&did="+a.dishList[c].did+"&count="+a.dishList[c].dishCount,function(d){console.log(d);updateTotaoNum()})}};a.jumpToOrder=function(){var c=angular.toJson(a.dishList);a.jump("order",{cartDetail:c})}}]);